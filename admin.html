<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8">
  <title>LifeCheck Admin Override</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 40px auto; }
    h1 { color: #f97316; }
    label { display:block; margin: 12px 0 4px; font-weight: 600; }
    input { width:100%; padding: 8px; border:1px solid #ddd; border-radius: 6px; }
    button { margin-top: 16px; padding: 10px 20px; border: none; border-radius: 8px;
             background: linear-gradient(90deg,#f97316,#ef4444); color: #fff; font-weight: 600; cursor:pointer; }
    .banner { margin-top: 20px; padding: 12px; border-radius: 8px; font-weight: 600; display:none; }
    .success { background: #dcfce7; color: #166534; border: 1px solid #16a34a; }
    .error   { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
    #override-form, #login-form { display:none; }
  </style>
</head>
<body>
  <h1>üîê Admin Override</h1>

  <!-- Login Form -->
  <form id="login-form">
    <label>Admin Password</label>
    <input type="password" id="admin-pass" required>
    <button type="submit">–ù—ç–≤—Ç—Ä—ç—Ö</button>
  </form>

  <!-- Override Form (hidden until login) -->
  <form id="override-form">
    <label>–ò–º—ç–π–ª</label>
    <input type="email" id="email" required>
    
    <label>Test Key (burnout, money, redflags, future)</label>
    <input type="text" id="testKey" required>
    
    <label>Test ID</label>
    <input type="text" id="testId" required>

    <label>Risk Level (low/mid/high/severe)</label>
    <input type="text" id="riskLevel">

    <button type="submit">üì© Report –∏–ª–≥—ç—ç—Ö</button>
  </form>

  <div id="banner" class="banner"></div>

  <script>
  const loginForm = document.getElementById('login-form');
  const overrideForm = document.getElementById('override-form');
  const banner = document.getElementById('banner');
  let adminKey = "";

  // –•—ç—Ä—ç–≤ ”©–º–Ω”© –Ω—å login —Ö–∏–π—Å—ç–Ω –±–æ–ª localStorage-–æ–æ—Å —Å—ç—Ä–≥—ç—ç—Ö
  const savedKey = localStorage.getItem("lc_adminKey");
  if (savedKey) {
    adminKey = savedKey;
    loginForm.style.display = "none";
    overrideForm.style.display = "block";
  } else {
    loginForm.style.display = "block";
  }

  // Login form
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const pass = document.getElementById('admin-pass').value;
    banner.style.display = "none";

    const res = await fetch('/api/adminLogin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pass })
    });

    const data = await res.json();
    if (data.ok) {
      adminKey = pass;
      localStorage.setItem("lc_adminKey", pass); // ‚úÖ Session —Ö–∞–¥–≥–∞–ª–Ω–∞
      loginForm.style.display = "none";
      overrideForm.style.display = "block";
    } else {
      banner.textContent = "‚ùå –ë—É—Ä—É—É password";
      banner.className = "banner error";
      banner.style.display = "block";
    }
  });

  // Override form submit
  overrideForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
      email: document.getElementById('email').value,
      testKey: document.getElementById('testKey').value,
      testId: document.getElementById('testId').value,
      riskLevel: document.getElementById('riskLevel').value
    };

    banner.style.display = "none";

    const res = await fetch('/api/adminSendReport', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + adminKey
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.ok) {
      banner.textContent = "‚úÖ Report –∞–º–∂–∏–ª—Ç—Ç–∞–π –∏–ª–≥—ç—ç–≥–¥–ª—ç—ç!";
      banner.className = "banner success";
    } else {
      banner.textContent = "‚ùå –ê–ª–¥–∞–∞: " + (data.error || "Unknown");
      banner.className = "banner error";
    }
    banner.style.display = "block";
  });
</script>
</body>
</html>
